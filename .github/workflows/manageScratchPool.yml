name: Replenish Scratch Pools

on:
  workflow_dispatch:
    inputs:
      pool-matrix-def-path:
        description: Path to the file describing the pools to create
        required: true
        type: string
        default: config/poolMatrixDef.json
      clear-pools:
        description: If checked, clear unused scratches in the pools
        required: true
        type: boolean
        default: false
      sfp-version:
        description: The version of SFP to use
        required: true
        type: string
        default: latest
  workflow_call:
    inputs:
      pool-matrix-def-path:
        description: Path to the file describing the pools to create
        required: false
        default: config/pool-matrix-def.json
        type: string
      clear-pools:
        description: If checked, clear unused scratches in the pools
        required: true
        type: boolean
      sfp-version:
        description: The version of SFP to use
        required: true
        default: latest
        type: string
    secrets:
      DEV_HUB_SFDX_URL:
        required: true
      METRICS_KEY:
        required: true
      CRM_PACKAGE_KEY:
        required: true
jobs:
  prepareMatrixRun:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      matrix-json: ${{ steps.getMatrix.outputs.matrix-json }}
    steps:
      - name: "Checkout code"
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          fetch-depth: 0
          persist-credentials: false
      - id: getMatrix
        run: |
          set -euo pipefail
          if [ ! -f "$POOL_MATRIX_DEF_PATH" ]; then
              echo "::error title=Matrix file not found::'$POOL_MATRIX_DEF_PATH'"
              exit 1
          fi

          if ! jq -e '.pools and (.pools | type=="array")' "$POOL_MATRIX_DEF_PATH" >/dev/null; then
              echo "::error title=Invalid matrix file::Expected a top-level 'pools' array in $POOL_MATRIX_DEF_PATH"
              jq . "$POOL_MATRIX_DEF_PATH" || true
              exit 1
          fi
          content=$(jq --compact-output '.' "$POOL_MATRIX_DEF_PATH")
          echo "matrix-json=$content" >> "$GITHUB_OUTPUT"
        env:
          POOL_MATRIX_DEF_PATH: ${{ inputs.pool-matrix-def-path }}

  replenish:
    concurrency:
      group: replenish-${{ github.workflow }}-${{ github.ref_name }}-${{ matrix.pool.poolConfigPath }}
      cancel-in-progress: false
    name: Replenish Pool
    needs: prepareMatrixRun
    runs-on: ubuntu-latest
    container: ghcr.io/flxbl-io/sfp:${{ inputs.sfp-version }}
    timeout-minutes: 720 #Set to Maximum Time out
    strategy:
      fail-fast: false
      matrix:
        pool: ${{ fromJson(needs.prepareMatrixRun.outputs.matrix-json).pools }}
    permissions:
      contents: read
      packages: read
    env:
      POOL_TAG: ""
      CLEAR_POOLS: ${{ inputs.clear-pools }}
      DEV_HUB_ALIAS: dev-hub
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Set pool tag
        run: |
          poolTag=$(jq --raw-output '.tag // empty' "$POOL_CONFIG_PATH")
          echo "POOL_TAG=$poolTag" >> "$GITHUB_ENV"
        env:
          POOL_CONFIG_PATH: ${{ matrix.pool.poolConfigPath }}

      - name: Print Values
        run: |
          echo Pool Tag: "$POOL_TAG"
          echo Pool Config Path: ${{ matrix.pool.poolConfigPath }}
          echo Pool Delete Job Type: ${{ matrix.pool.deleteJobType }}
          echo Clear unused scratch orgs: "$CLEAR_POOLS"

      - name: "Authenticate Dev Hub"
        uses: navikt/crm-workflows-base/.github/actions/authenticateOrg@c941a6ea7474883b849e53f69eb4eeba83854fe7
        with:
          auth-url: ${{ secrets.DEV_HUB_SFDX_URL }}
          setDefaultDevhubUsername: true
          alias: ${{ env.DEV_HUB_ALIAS }}

      - name: Clear pool
        id: clearPool
        if: ${{ inputs.clear-pools }}
        uses: navikt/sf-gha-deleteScratchPool@1f0986d2312a2969e658946acb496f6dcd7d4032
        with:
          devhub: ${{ env.DEV_HUB_ALIAS }}
          poolTag: ${{ env.POOL_TAG }}
          deleteJobType: ${{ matrix.pool.deleteJobType }}
          isCiPool: ${{ matrix.pool.isCiPool }}

      - name: Create Pool
        uses: navikt/crm-workflows-base/.github/actions/preparePool@134a14b95c52d8d51445f20e5f2cda3226b1da46
        with:
          dev-hub: ${{ env.DEV_HUB_ALIAS }}
          package-key: ${{ secrets.CRM_PACKAGE_KEY }}
          pool-config-path: ${{ matrix.pool.poolConfigPath }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete orphans
        uses: navikt/sf-gha-deleteScratchPool@1f0986d2312a2969e658946acb496f6dcd7d4032
        with:
          devhub: ${{ env.DEV_HUB_ALIAS }}
          deleteJobType: orphans
          isCiPool: ${{ matrix.pool.isCiPool }}

      - name: Push logged metrics
        if: ${{ always() }}
        uses: navikt/sf-platform/.github/actions/pushLoggedMetrics@d77aeff38e7ba9938368c80e415f8615b1cc4308
        with:
          metricsKey: ${{ secrets.METRICS_KEY }}

name: "Create Package"
on:
  workflow_call:
    inputs:
      create-alpha-package:
        description: "Whether to create an alpha package (skip validation)"
        required: false
        type: boolean
        default: false
      installation-key-bypass:
        description: "Whether to bypass the installation key for the package"
        required: false
        type: boolean
        default: false
      scratch-org-def-file:
        description: "Path to scratch org definition file"
        required: false
        type: string
        default: config/project-scratch-def.json
      metadata-path:
        description: "Path to metadata to deploy after package installation"
        required: false
        type: string
      version-description:
        description: "Description for the package version"
        required: false
        type: string

      wait:
        description: "Wait time for package creation (minutes)"
        required: false
        type: number
        default: 120
    secrets:
      DEV_HUB_AUTH_URL:
        required: true
      SIT_AUTH_URL:
        required: true
      PACKAGE_KEY:
        required: false
permissions: {}
jobs:
  create-package:
    name: Create Package Version
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      package-id: ${{ steps.package-version-create.outputs.package-id }}
      version-number: ${{ steps.package-version-create.outputs.version-number }}
      code-coverage: ${{ steps.package-version-create.outputs.code-coverage }}
    env:
      DEV_HUB_ALIAS: devhub
    steps:
      # Checkout source code
      - name: Checkout source code
        uses: actions/checkout@v5
        with:
          fetch-depth: 1
          persist-credentials: false

      # Install SF
      - name: Install SF
        uses: navikt/sf-gha-install-sf-cli@3f1abbc990b03fb544e80169920fea2e94946d1a

      # Authorize Dev Hub
      - name: Authorize PROD
        uses: navikt/sf-gha-authenticateOrg@da2f995ee865e05111574719abfc5ba12b459f0c
        with:
          auth-url: ${{ secrets.DEV_HUB_AUTH_URL }}
          alias: ${{ env.DEV_HUB_ALIAS }}
          setDefaultUsername: true
          setDefaultDevhubUsername: true

      # Delete unpackagable and scratch-org folder
      - name: Delete unpackagable
        run: |
          rm -rf ./force-app/unpackagable
          rm -rf ./force-app/unpackagable-with-auto-deploy
          rm -rf ./force-app/scratch-org
      # Create package version
      - name: Create package version
        id: package-version-create
        env:
          SCRATCH_ORG_DEF_FILE: ${{ inputs.scratch-org-def-file }}
          WAIT: ${{ inputs.wait }}
          CREATE_ALPHA_PACKAGE: ${{ inputs.create-alpha-package }}
          INSTALLATION_KEY_BYPASS: ${{ inputs.installation-key-bypass }}
          BRANCH_NAME: ${{ github.ref_name }}
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
          PACKAGE_VERSION_DESCRIPTION: ${{ inputs.version-description }}
        run: |
          set -euo pipefail

          packageName=$(jq -r '.packageDirectories[0].package' sfdx-project.json)

          command=("sf" "package" "version" "create" \
            "--target-dev-hub" "$DEV_HUB_ALIAS" \
            "--definition-file" "$SCRATCH_ORG_DEF_FILE" \
            "--package" "$packageName" \
            "--wait" "$WAIT" \
            "--verbose" \
            "--json" )

          if [ "$BRANCH_NAME" != "$DEFAULT_BRANCH" ]; then
            command+=("--branch" "$BRANCH_NAME")
          fi

          if [ "$CREATE_ALPHA_PACKAGE" = true ]; then
            command+=("--skip-validation")
          else
            command+=("--code-coverage")
          fi

          if [ -n "$PACKAGE_VERSION_DESCRIPTION" ]; then
            command+=("--description" "$PACKAGE_VERSION_DESCRIPTION")
          fi

          if [ "$INSTALLATION_KEY_BYPASS" = true ]; then
            command+=("--installation-key-bypass")
            echo "Command to execute: ${command[*]}"
          else
            echo "Command to execute: ${command[*]}"
            
            echo "Installation key provided."
            command+=( "--installation-key" "${{ secrets.PACKAGE_KEY }}" )
          fi

          "${command[@]}" 1> output.json 2> stderr.log || {
            echo "::error title=Package version creation failed.::See stderr.log for details."
            exit 1
          }

          STATUS=$(jq -r '.status' output.json)

          if [ "$STATUS" = "0" ]; then
            echo "âœ… Package version created successfully."
          else
            MESSAGE=$(jq -r '.message // "Unknown error"' output.json)
            echo "::error title=Package installation failed.::$MESSAGE"
            exit 1
          fi

          packageId=$(jq -r '.result.SubscriberPackageVersionId' output.json)
          versionNumber=$(jq -r '.result.VersionNumber' output.json)
          codeCoverage=$(jq -r '.result.CodeCoverage // 0' )
          echo "package-id=$packageId" >> $GITHUB_OUTPUT
          echo "version-number=$versionNumber" >> $GITHUB_OUTPUT
          echo "code-coverage=$codeCoverage" >> $GITHUB_OUTPUT

      - name: Upload diagnostics
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: create-package-version-diagnostics
          path: |
            stderr.log
            output.json
          if-no-files-found: warn
          retention-days: 7

  create-release:
    name: Create release
    needs: [create-package]
    runs-on: ubuntu-latest
    permissions:
      contents: write # Needed to create releases
    steps:
      # Checkout source code
      - name: Checkout source code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          persist-credentials: false

      # set release variables
      - name: Set release variables
        id: release-variables
        env:
          VERSION_NUMBER: ${{ needs.create-package.outputs.version-number }}
          CREATE_ALPHA_PACKAGE: ${{ inputs.create-alpha-package }}
          INSTALLATION_KEY_BYPASS: ${{ inputs.installation-key-bypass }}
          BRANCH_NAME: ${{ github.ref_name }}
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
        run: |
          set -euo pipefail

          IFS='.' read -r major minor patch build <<< "$VERSION_NUMBER"

          versionNumber="$major.$minor.$patch"
          prereleaseTag="beta"

          if [ "$CREATE_ALPHA_PACKAGE" = "true" ]; then
            prereleaseTag="alpha"
          fi

          version="${versionNumber}-${prereleaseTag}.${build}"

          if [ "$BRANCH_NAME" != "$DEFAULT_BRANCH" ]; then
            version+="+${BRANCH_NAME}"
          fi

          echo "tag-name=v${version}" >> $GITHUB_OUTPUT
          echo "release-name=$version" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        uses: metcalfc/changelog-generator@3f82cef08fe5dcf57c591fe165e70e1d5032e15a
        with:
          mytoken: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release
        uses: softprops/action-gh-release@5be0e66d93ac7ed76da52eca8bb058f665c3a5fe
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag_name: ${{ steps.release-variables.outputs.tag-name }}
          name: ${{ steps.release-variables.outputs.release-name }}
          body: |
            **Version**: ${{ needs.create-package.outputs.version-number }}
            **Package ID**: ${{ needs.create-package.outputs.package-id }}
            **Code Coverage**: ${{ needs.create-package.outputs.code-coverage }}%
            **Author**: ${{ github.actor }}

            ## Changelog
            ${{ steps.changelog.outputs.changelog }}
          draft: false
          prerelease: true
          generate_release_notes: true

  validate-in-sit:
    if: ${{ github.ref_name == github.event.repository.default_branch }}
    name: Install in SIT Sandbox
    needs: [create-package, create-release]
    uses: navikt/crm-workflows-base/.github/workflows/deploy.yml@main
    with:
      package-id: ${{ needs.create-package.outputs.package-id }}
      org: sit
      metadata-path: ${{ inputs.metadata-path }}
    permissions:
      contents: read
    secrets:
      SIT_AUTH_URL: ${{ secrets.SIT_AUTH_URL }}
      PACKAGE_KEY: ${{ secrets.PACKAGE_KEY }}

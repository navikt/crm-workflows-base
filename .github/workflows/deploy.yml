name: Deploy
on:
  workflow_call:
    inputs:
      org:
        description: "Org (prod, preprod, dev, uat, sit)"
        required: true
        type: string
      package-id:
        description: "Package ID"
        required: false
        type: string
      metadata-path:
        description: "Path to metadata folder"
        required: false
        type: string
      install-wait:
        description: "Wait time for package install (minutes)"
        required: false
        type: number
        default: 10
      publish-wait:
        description: "Publish wait time (minutes)"
        required: false
        type: number
        default: 10
    outputs:
      package-installation-result:
        description: "Result of package installation"
        value: ${{ jobs.deploy-package.outputs.package-installation-result }}
      metadata-deployment-result:
        description: "Result of metadata deployment"
        value: ${{ jobs.deploy-package.outputs.metadata-deployment-result }}
    secrets:
      PROD_AUTH_URL:
        required: false
      PREPROD_AUTH_URL:
        required: false
      DEV_AUTH_URL:
        required: false
      UAT_AUTH_URL:
        required: false
      SIT_AUTH_URL:
        required: false
      PACKAGE_KEY:
        required: false

permissions: {}
jobs:
  deploy-package:
    name: Deploy
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      TARGET_ORG: targetOrg
    outputs:
      package-installation-result: ${{ steps.set-output.outputs.package-installation-result }}
      metadata-deployment-result: ${{ steps.set-output.outputs.metadata-deployment-result }}
    steps:
      # Set SF Auth URL
      - name: Set SF Auth URL
        id: auth-url
        shell: bash
        run: |
          set -euo pipefail
          case "$ORG" in
            prod)       SF_AUTH_URL="${{ secrets.PROD_AUTH_URL }}" ;;
            preprod)    SF_AUTH_URL="${{ secrets.PREPROD_AUTH_URL }}" ;;
            dev)        SF_AUTH_URL="${{ secrets.DEV_AUTH_URL }}" ;;
            uat)        SF_AUTH_URL="${{ secrets.UAT_AUTH_URL }}" ;;
            sit)        SF_AUTH_URL="${{ secrets.SIT_AUTH_URL }}" ;;
            *)          SF_AUTH_URL="$ORG" ;;
          esac
          echo "Auth URL set for $ORG"
          echo "SF_AUTH_URL=$SF_AUTH_URL" >> "$GITHUB_ENV"
        env:
          ORG: "${{ inputs.org }}"

      # Install SF
      - name: Install SF
        uses: navikt/sf-gha-install-sf-cli@3f1abbc990b03fb544e80169920fea2e94946d1a

      # Authorize SF
      - name: Authorize SF
        uses: navikt/sf-gha-authenticateOrg@da2f995ee865e05111574719abfc5ba12b459f0c
        with:
          auth-url: ${{ env.SF_AUTH_URL }}
          alias: ${{ env.TARGET_ORG }}
          setDefaultUsername: true
          setDefaultDevhubUsername: false

      # Install package in target org
      - uses: navikt/sf-gha-install-package@f33ba85b73abc2230720d228bcbc66ac70e28d15
        id: install-package
        if: ${{ inputs.package-id != '' }}
        with:
          target-org: ${{ env.TARGET_ORG }}
          package-id: ${{ inputs.package-id }}
          package-key: ${{ secrets.PACKAGE_KEY }}
          install-wait: ${{ inputs.install-wait }}
          publish-wait: ${{ inputs.publish-wait }}

      # Checkout source code
      - name: Checkout source code from master
        uses: actions/checkout@v5
        with:
          persist-credentials: false
          fetch-depth: 1

      # Deploy metadata
      - uses: navikt/sf-gha-deploy-metadata@accafcc1b6ffbb479e2e4d4f45146590fc59adab
        id: deploy-metadata
        if: ${{ inputs.metadata-path != '' }}
        with:
          path: ${{ inputs.metadata-path }}
          target-org: ${{ env.TARGET_ORG }}
          validate-only: false

      - name: Set output
        id: set-output
        if: always()
        run: |
          echo "package-installation-result=${STEPS_INSTALL_PACKAGE_OUTCOME}" >> $GITHUB_OUTPUT
          echo "metadata-deployment-result=${STEPS_DEPLOY_METADATA_OUTCOME}" >> $GITHUB_OUTPUT
        env:
          STEPS_INSTALL_PACKAGE_OUTCOME: ${{ steps.install-package.outcome }}
          STEPS_DEPLOY_METADATA_OUTCOME: ${{ steps.deploy-metadata.outcome }}
